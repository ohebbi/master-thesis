# Tables
import pandas as pd

# Visual representation of the query process
from tqdm import tqdm

# ML library and structural library
from aflowml.client import AFLOWmlAPI

from pymatgen import Structure
from pymatgen.io.vasp.inputs import Poscar
from pymatgen.io.cif import CifParser

import os
if not os.path.exists('data'):
    os.makedirs('data')

def get_dataframe_AFLOW_ML(entries, pathAndFileName = False):
    """
        A function used to initialise AFLOW-ML with appropiate inputs.
        ...
        Args
        ----------
        entries : Pandas DataFrame
        {
            "cif": {}
                - Materials Project parameter "cif", which is a dict
            "compound": []
                - list of strings
            "material id": []
                - list of strings
        }
        fileName : str
            Path to file, e.g. "data/aflow_ml.csv"
            Writing to a file during iterations. Recommended for large entries.

        Returns
        -------
        Pandas DataFrame
            A DataFrame containing features as compound and material id,
            as well as the keys in the AFLOW-ML algorithm Property
            Labeled Material Fragments.
        """
        def writeToFile(fileName, row):
            pd.DataFrame.from_dict(AFLOW_ML).loc[[index]].to_csv(fileName,
                sep=",",
                index=False,
                header=False,
                mode='a')

        firstIteration = True
        for index, entry in tqdm(entries.iterrows()):

            struc = CifParser.from_string(entry["cif"]).get_structures()[0]

            poscar = Poscar(structure=struc)

            ml = AFLOWmlAPI()
            prediction = ml.get_prediction(poscar, 'plmf')

            if firstIteration:
                AFLOW_ML = {k: [] for k in prediction.keys()}
                AFLOW_ML["full_formula"]    = []
                AFLOW_ML["material_id"] = []
                firstIteration = False

            for key in prediction.keys():
                AFLOW_ML[key].append(prediction[key])

            AFLOW_ML["full_formula"].append(entry["full_formula"])
            AFLOW_ML["material_id"].append(entry["material_id"])

            if (pathAndFileName):
                writeToFile(pathAndFileName, row=pd.DataFrame.from_dict(AFLOW_ML).loc[[index]])

        return pd.DataFrame.from_dict(AFLOW_ML)
